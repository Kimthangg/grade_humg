<!-- Form Upload File -->
<form action="/" method="POST" enctype="multipart/form-data" class="p-4 bg-light shadow rounded text-center">
    <input type="file" name="file" id="fileInput" class="form-control mb-3 p-3 rounded" accept=".xlsx" required>
    <button type="submit" class="btn btn-primary px-4 py-2 fw-bold shadow">üìÇ T·∫£i l√™n</button>
</form>

<!-- B·∫£ng hi·ªÉn th·ªã d·ªØ li·ªáu -->
<table class="table">
    <thead>
        <tr>
            <th>M√£ MH</th>
            <th>T√™n m√¥n h·ªçc</th>
            <th>S·ªë t√≠n ch·ªâ</th>
            <th>ƒêi·ªÉm TK (10)</th>
            <th>ƒêi·ªÉm TK (C)</th>
            <th>H√†nh ƒë·ªông</th>
        </tr>
    </thead>
    <tbody id="courseTableBody"></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
document.getElementById('fileInput').addEventListener('change', importFromExcel);

function importFromExcel(event) {
    const file = event.target.files[0];

    if (!file) { 
        console.error("Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c ch·ªçn!");
        return;
    }

    const reader = new FileReader();

    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        // L·∫•y d·ªØ li·ªáu t·ª´ sheet ƒë·∫ßu ti√™n c·ªßa workbook
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        let rows = XLSX.utils.sheet_to_json(worksheet);

        // L·ªçc ra c√°c m√¥n h·ªçc
        rows = rows.filter(row => row["T√™n m√¥n h·ªçc"]);
                
        // Lo·∫°i b·ªè c√°c m√£ h·ªçc ph·∫ßn kh√¥ng h·ª£p l·ªá
        rows = rows.map(row => {
            let courseCode = Number(row["M√£ MH"]);
            return isNaN(courseCode) ? null : { ...row, "M√£ MH": courseCode };
        }).filter(row => row);

        // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu sang object
        const formattedRows = rows.map(row => ({
            course_code: row["M√£ MH"],
            subject: row["T√™n m√¥n h·ªçc"],
            credits: row["S·ªë t√≠n ch·ªâ"],
            final_score: row["ƒêi·ªÉm TK (10)"],
            letter_grade: row["ƒêi·ªÉm TK (C)"]
        }));

        // Th√™m d·ªØ li·ªáu v√†o b·∫£ng
        const tableBody = document.getElementById('courseTableBody');
        tableBody.innerHTML = ""; // X√≥a d·ªØ li·ªáu c≈©

        formattedRows.forEach(row => {
            const newRow = tableBody.insertRow();
            newRow.insertCell(0).innerText = row.course_code;
            newRow.insertCell(1).innerText = row.subject;
            newRow.insertCell(2).innerText = row.credits;
            newRow.insertCell(3).innerText = row.final_score;
            newRow.insertCell(4).innerText = row.letter_grade;

            // Th√™m n√∫t S·ª≠a v√† X√≥a
            const actionsCell = newRow.insertCell(5);
            actionsCell.innerHTML = `
                <div class="btn-group">
                    <button onclick="editCourse(this)">S·ª≠a</button>
                    <button class="delete-button" onclick="deleteCourse(this)">X√≥a</button>
                </div>
            `;
        });

        // C·∫≠p nh·∫≠t t·ªïng ƒëi·ªÉm
        updateTotals();
    };

    reader.readAsArrayBuffer(file);
}

// H√†m X√≥a h√†ng
function deleteCourse(button) {
    const row = button.closest("tr");
    row.remove();
}

// H√†m ch·ªânh s·ª≠a (ƒë∆°n gi·∫£n, c√≥ th·ªÉ c·∫£i thi·ªán)
function editCourse(button) {
    const row = button.closest("tr").cells;
    const newValue = prompt("Nh·∫≠p gi√° tr·ªã m·ªõi:", row[1].innerText);
    if (newValue) row[1].innerText = newValue;
}

// H√†m t√≠nh t·ªïng ƒëi·ªÉm (ƒë∆°n gi·∫£n, c√≥ th·ªÉ t√πy ch·ªânh)
function updateTotals() {
    console.log("C·∫≠p nh·∫≠t t·ªïng ƒëi·ªÉm...");
}
</script>
